<ol id="messages-content"></ol>

<div id="chat-footer">
    <button id="msg_submit" onclick='sendMessage()'>Send</button>
    <div id="chat-input-container">
        <input id="chat-input" />
    </div>
</div>

<script>
    var chat_room_id = {{ chat_room_id }};
    var user_id = {{ user_id }};

    var last_seen_id = null;

    function getCookie(name) {
        var cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            var cookies = document.cookie.split(';');
            for (var i = 0; i < cookies.length; i++) {
                var cookie = jQuery.trim(cookies[i]);
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    if (typeof csrftoken  === 'undefined' || csrftoken  === null) {
        var csrftoken = getCookie('csrftoken');
    }

    $.ajaxSetup({
        beforeSend: function(xhr, settings) {
            if (settings.type === "POST" && !this.crossDomain) {
                xhr.setRequestHeader("X-CSRFToken", csrftoken);
            }
        }
    });

    function getUserProfile(id) {
        var user_profile_url = "{% url 'chat_room:api' 0 %}";
        return user_profile_url.replace(/0/, id.toString());
    }

    function updateChat( data ) {
        for (var i in data) {
            var date = new Date(data[i].date);

            var li_class;

            if (data[i].user_id === user_id)
                li_class = "self";
            else
                li_class = "other";

            $("#messages-content").append(
                "<li class='"+ li_class +"'>"
                    +"<div class='bubble'>"
                        + "<div class='user'><a href='" + getUserProfile(data[i].user_id) + "'>" + data[i].user + "</a></div>"
                        + "<hr/>"
                        + "<div class='message-text'>" + data[i].msg + "</div>"
                        + "<div class='message-date'>" + date.toLocaleTimeString() + "</div>"
                    + "</div>"
                + "</li>");

            last_seen_id = data[i].id;
        }

        if (data.length > 0)
            $('#messages-content').animate({scrollTop: $('#messages-content')[0].scrollHeight}, 500);
    }

    $(function() {
        $('#msg_submit').attr('disabled', 'disabled');
        $('#chat-input').keyup(function() {
            $('#chat-input').each(function() {
                if ($(this).val().replace(/\s/g, "") .length == 0) {
                    $('#msg_submit').attr('disabled', 'disabled');
                } else {
                    $('#msg_submit').removeAttr('disabled');
                }
            });
        });

        function getNewComments() {
            $.ajax({
                type: "POST",
                url: "/chat_room/" + chat_room_id + "/api/",
                data: {
                    last_seen_id: last_seen_id
                },
                success: function( data ) {
                    updateChat( data );
                }
            });

            setTimeout( getNewComments, 3000 );
        }

        getNewComments();

    });

    function sendMessage() {
        var msg = $("#chat-input").val();

        $.ajax({
            type: "POST",
            url: "/chat_room/" + chat_room_id + "/api/",
            data: {
                msg: msg,
                last_seen_id: last_seen_id
            },
            success: function( data ) {
                updateChat(data);
            }
        });

        $("#chat-input").val('');
    }
</script>
